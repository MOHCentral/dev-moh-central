# =============================================================================
# MOHAA Stats Forum (SMF + MySQL)
# =============================================================================
# Deploy via Portainer: Repository â†’ https://github.com/MOHCentral/opm-stats-system
# Compose path: opm-stats-web/docker-compose.yml
# =============================================================================

services:
  # ============================================================================
  # SMF Forum with MOHAA Stats Plugin
  # ============================================================================
  smf:
    build:
      context: .
      dockerfile: Dockerfile
    image: mohaa-stats-smf:latest
    container_name: mohaa-smf
    labels:
      - "com.mohaa.service=smf"
      - "com.mohaa.description=SMF Forum with MOHAA Stats Plugin"
    ports:
      - "8083:80"
    environment:
      # SMF Database
      - SMF_DB_HOST=smf-mysql
      - SMF_DB_NAME=${SMF_DB_NAME:-smf}
      - SMF_DB_USER=${SMF_DB_USER:-smf}
      - SMF_DB_PASS=${SMF_DB_PASS:-smf_password}
      # MOHAA Stats API Connection
      - MOHAA_API_URL=${MOHAA_API_URL:-http://77.42.64.214:8084/api/v1}
      - MOHAA_API_PUBLIC_URL=${MOHAA_API_PUBLIC_URL:-http://77.42.64.214:8084/api/v1}
    volumes:
      - smf-settings:/var/www/html/smf-config
      - smf-attachments:/var/www/html/attachments
      - smf-avatars:/var/www/html/avatars
      - smf-cache:/var/www/html/cache
      - smf-packages:/var/www/html/Packages
    depends_on:
      smf-mysql:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - mohaa-network

  # ============================================================================
  # MySQL for SMF Forum
  # ============================================================================
  smf-mysql:
    image: mysql:8.0
    container_name: mohaa-smf-mysql
    labels:
      - "com.mohaa.service=smf-mysql"
      - "com.mohaa.description=MySQL database for SMF Forum"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_password}
      - MYSQL_DATABASE=${SMF_DB_NAME:-smf}
      - MYSQL_USER=${SMF_DB_USER:-smf}
      - MYSQL_PASSWORD=${SMF_DB_PASS:-smf_password}
    ports:
      - "3307:3306"
    volumes:
      - smf-mysql-data:/var/lib/mysql
      - ./init-db:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - mohaa-network

  # ============================================================================
  # phpMyAdmin (optional, for database management)
  # ============================================================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: mohaa-phpmyadmin
    labels:
      - "com.mohaa.service=phpmyadmin"
      - "com.mohaa.description=Database management UI"
    ports:
      - "8889:80"
    environment:
      - PMA_HOST=smf-mysql
      - PMA_USER=root
      - PMA_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_password}
    depends_on:
      - smf-mysql
    restart: unless-stopped
    networks:
      - mohaa-network

volumes:
  smf-mysql-data:
  smf-settings:
  smf-attachments:
  smf-avatars:
  smf-cache:
  smf-packages:

networks:
  mohaa-network:
    driver: bridge
