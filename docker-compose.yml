# =============================================================================
# MOHAA Stats Forum (SMF + MySQL)
# =============================================================================
# Deploy via Portainer: Repository â†’ https://github.com/MOHCentral/opm-stats-system
# Compose path: opm-stats-web/docker-compose.yml
# =============================================================================

services:
  # ============================================================================
  # SMF Forum with MOHAA Stats Plugin
  # ============================================================================
  dev-smf:
    image: ghcr.io/mohcentral/dev-moh-central:latest
    container_name: dev-smf
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      - "com.mohaa.service=dev-smf"
      - "com.mohaa.description=SMF Forum with MOHAA Stats Plugin"
    ports:
      - "8083:80"
    environment:
      # SMF Database
      - SMF_DB_HOST=dev-smf-mysql
      - SMF_DB_NAME=${SMF_DB_NAME}
      - SMF_DB_USER=${SMF_DB_USER}
      - SMF_DB_PASS=${SMF_DB_PASS}
      # MOHAA Stats API Connection
      - MOHAA_API_URL=${MOHAA_API_URL}
      - MOHAA_API_PUBLIC_URL=${MOHAA_API_PUBLIC_URL}
    volumes:
      - dev-smf-settings:/var/www/html/smf-config
      - dev-smf-attachments:/var/www/html/attachments
      - dev-smf-avatars:/var/www/html/avatars
      - dev-smf-cache:/var/www/html/cache
      - dev-smf-packages:/var/www/html/Packages
    depends_on:
      dev-smf-mysql:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - opm-stats-network

  # ============================================================================
  # MySQL for SMF Forum
  # ============================================================================
  dev-smf-mysql:
    image: mysql:8.0
    container_name: dev-smf-mysql
    labels:
      - "com.mohaa.service=smf-mysql"
      - "com.mohaa.description=MySQL database for SMF Forum"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${SMF_DB_NAME}
      - MYSQL_USER=${SMF_DB_USER}
      - MYSQL_PASSWORD=${SMF_DB_PASS}
    ports:
      - "3307:3306"
    volumes:
      - dev-smf-mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - opm-stats-network

  # ============================================================================
  # phpMyAdmin (optional, for database management)
  # ============================================================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: mohaa-phpmyadmin
    labels:
      - "com.mohaa.service=phpmyadmin"
      - "com.mohaa.description=Database management UI"
    ports:
      - "8889:80"
    environment:
      - PMA_HOST=dev-smf-mysql
      - PMA_USER=root
      - PMA_PASSWORD=${MYSQL_ROOT_PASSWORD}
    depends_on:
      - dev-smf-mysql
    restart: unless-stopped
    networks:
      - opm-stats-network

volumes:
  dev-smf-mysql-data:
  dev-smf-settings:
  dev-smf-attachments:
  dev-smf-avatars:
  dev-smf-cache:
  dev-smf-packages:

networks:
  opm-stats-network:
    external: true
    name: opm-stats-network
